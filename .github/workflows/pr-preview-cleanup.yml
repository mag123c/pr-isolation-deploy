name: PR Preview - Cleanup
run-name: "ğŸ§¹ pr-${{ github.event.number }}.${{ vars.DOMAIN || 'ounwan.net' }} í…ŒìŠ¤íŠ¸ í™˜ê²½ ì •ë¦¬"

on:
  pull_request:
    types: [closed]
    branches:
      - main

concurrency:
  group: pr-preview-${{ github.event.number }}
  cancel-in-progress: false

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: preview-cluster2
  DOMAIN: ounwan.net

jobs:
  cleanup:
    name: ğŸ—‘ï¸ í™˜ê²½ ì •ë¦¬
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” AWS ì¸ì¦
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Preview í™˜ê²½ ì¡´ì¬ í™•ì¸
        id: check
        run: |
          SERVICE=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services pr-${{ github.event.number }} \
            --query 'services[0].serviceName' \
            --output text 2>/dev/null || echo "None")
          echo "exists=$([[ "$SERVICE" != "None" && -n "$SERVICE" ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: ğŸ›‘ ECS ì„œë¹„ìŠ¤ ì‚­ì œ
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "Stopping service..."
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service pr-${{ github.event.number }} \
            --desired-count 0

          echo "Waiting for tasks to stop..."
          sleep 10

          echo "Deleting service..."
          aws ecs delete-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service pr-${{ github.event.number }} \
            --force

      - name: ğŸ”€ ALB ë¼ìš°íŒ… ê·œì¹™ ì‚­ì œ
        if: steps.check.outputs.exists == 'true'
        run: |
          RULE_ARN=$(aws elbv2 describe-rules \
            --listener-arn ${{ secrets.LISTENER_ARN }} \
            --query "Rules[?Priority=='${{ github.event.number }}'].RuleArn" \
            --output text)

          if [ -n "$RULE_ARN" ] && [ "$RULE_ARN" != "None" ]; then
            echo "Deleting ALB rule..."
            aws elbv2 delete-rule --rule-arn $RULE_ARN
          fi

      - name: ğŸ¯ Target Group ì‚­ì œ
        if: steps.check.outputs.exists == 'true'
        run: |
          TG_ARN=$(aws elbv2 describe-target-groups \
            --names pr-${{ github.event.number }}-tg \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text 2>/dev/null || echo "")

          if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
            echo "Deleting Target Group..."
            aws elbv2 delete-target-group --target-group-arn $TG_ARN
          fi

      - name: ğŸ“‹ Task Definition ì •ë¦¬
        if: steps.check.outputs.exists == 'true'
        run: |
          TASK_DEFS=$(aws ecs list-task-definitions \
            --family-prefix pr-${{ github.event.number }}-web \
            --query 'taskDefinitionArns' \
            --output text)

          for TASK_DEF in $TASK_DEFS; do
            echo "Deregistering: $TASK_DEF"
            aws ecs deregister-task-definition --task-definition $TASK_DEF || true
          done

      - name: âœ… ì •ë¦¬ ì™„ë£Œ
        run: |
          echo "ğŸ§¹ pr-${{ github.event.number }}.${{ env.DOMAIN }} í™˜ê²½ì´ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."
