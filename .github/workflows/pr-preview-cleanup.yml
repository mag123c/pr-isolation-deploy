name: PR Preview Cleanup

on:
  pull_request:
    types: [closed]
    branches:
      - main

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: preview-cluster2

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if preview exists
        id: check
        run: |
          SERVICE=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services pr-${{ github.event.number }} \
            --query 'services[0].serviceName' \
            --output text 2>/dev/null || echo "None")
          echo "exists=$([[ "$SERVICE" != "None" && -n "$SERVICE" ]] && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Delete ECS service
        if: steps.check.outputs.exists == 'true'
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service pr-${{ github.event.number }} \
            --desired-count 0

          sleep 10

          aws ecs delete-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service pr-${{ github.event.number }} \
            --force

      - name: Delete ALB rule
        if: steps.check.outputs.exists == 'true'
        run: |
          RULE_ARN=$(aws elbv2 describe-rules \
            --listener-arn ${{ secrets.LISTENER_ARN }} \
            --query "Rules[?Priority=='${{ github.event.number }}'].RuleArn" \
            --output text)

          if [ -n "$RULE_ARN" ] && [ "$RULE_ARN" != "None" ]; then
            aws elbv2 delete-rule --rule-arn $RULE_ARN
          fi

      - name: Delete Target Group
        if: steps.check.outputs.exists == 'true'
        run: |
          TG_ARN=$(aws elbv2 describe-target-groups \
            --names pr-${{ github.event.number }}-tg \
            --query 'TargetGroups[0].TargetGroupArn' \
            --output text 2>/dev/null || echo "")

          if [ -n "$TG_ARN" ] && [ "$TG_ARN" != "None" ]; then
            aws elbv2 delete-target-group --target-group-arn $TG_ARN
          fi

      - name: Deregister task definition
        if: steps.check.outputs.exists == 'true'
        run: |
          TASK_DEFS=$(aws ecs list-task-definitions \
            --family-prefix pr-${{ github.event.number }}-web \
            --query 'taskDefinitionArns' \
            --output text)

          for TASK_DEF in $TASK_DEFS; do
            aws ecs deregister-task-definition --task-definition $TASK_DEF || true
          done
